/**
 * Created by crystalneth on 10-Jun-17.
 */

class Player {
    // TODO documentation
    /**
     * Constructor for a player object. Note that the constructor immediately checks,
     * whether the provided blueprint-string is a valid JSON-Password Composition Policy or not.
     * @param blueprintJson password policy specification blueprint (JSON String)
     */
    constructor(blueprintJson, schema) {
        this.schema = JSON.parse(schema);
        this.blueprint = this._parseBlueprint(blueprintJson, this.schema);
        // Ich glaube wir brauchen auch noch irgendwo den Username als Parameter, da wir den bei den RegExp
    }

    /**
     *
     */
    generateValidPassword() {
        let validation = false;

        while(!validation){
            try {
                this.password = this._invokePasswordGenerator(this.blueprint);
            } catch(err) {
                validation = false;
            }
            validation = true;
        }
    }

    // Bekommen wir einen JSON-String oder ein JSON-Objekt?
    /**
     * Validates the password policy blueprint against the Password Composition Policy schema
     * @param blueprintJson JSON String of the password composition policy blueprint
     * @param schema JSON schema, the blueprint is validated against
     * @private
     */
    _parseBlueprint(blueprintJson, schema) {
        const Ajv = require('ajv');
        const ajv = new Ajv();
        const validate = ajv.compile(schema);
        const blueprint = JSON.parse(blueprintJson);

        if (validate(blueprint)) {
            return blueprint;
        } else {
            console.log(validate.errors);
            throw "Blueprint doesn't follow JSON schema"
        }
    }

    /**
     * Invokes the password generator to generate a Password with the specified maximum length and allowed character set, which are specified in the blueprint
     * @param blueprint The password composition policy blueprint
     * @returns {String} password generated by the password generator.
     * @private
     */
    _invokePasswordGenerator(blueprint) {
        const passwordGenerator = new PasswordGen();

        let maxLength = this.blueprint[0].maxLength;
        const allowsCharacterSets = this.blueprint[0].allowedCharacterSets;
        //TODO: use the get characterSet method?
        let alphabet = allowsCharacterSets.az + allowsCharacterSets.AZ + allowsCharacterSets.num +  allowsCharacterSets.special;

        return passwordGenerator.generatePassword(maxLength, alphabet);
    }

    /**
     *Tests the password on all the Regular Expressions contained in the blueprint, that specify the password compostion policies.
     * Note that some policies can't be tested, like (May not be the same as the last 5 passwords used." As the old passwords are not stored in the password manager.
     * @param password Password to be tested
     * @param blueprint Blueprint containing password composition policies
     * @returns {boolean} true if the password satisfies the policies
     * @private
     */
    _validatePassword(password, blueprint) {
        for (let requirement of blueprint[0].compositionRequirements) {
            if (!this._test(password, requirement, blueprint[0].allowedCharacterSets)) {
                return false;
            }
        }
        return true;
    }

    _test(password, requirement, allowedCharacterSets) {
        let regExp = requirement.rule.regexp;

        const az = allowedCharacterSets.az;
        const AZ = allowedCharacterSets.AZ;
        const num = allowedCharacterSets.num;
        const special = allowedCharacterSets.special;
        const username = 'testusername';
        const passwords = ['012345678', 'password', 'asdf', 'test', 'P@ssword123'];

        regExp = regExp.replace('az', az);
        regExp = regExp.replace('AZ', AZ);
        regExp = regExp.replace('num', num);
        regExp = regExp.replace('special', special);
        regExp = regExp.replace('[username]', username);

        if (regExp.includes('[password]')) {
            let newValue = '(';
            for (let pw of passwords) {
                newValue += pw + '|'
            }
            newValue = newValue.substr(0, newValue.length - 1) + ')';
            regExp = regExp.replace('[password]', newValue);
        }

        regExp = new RegExp(regExp, 'gi');

        let result = regExp.test(password);

        //console.log(password,  ": ", regExp.toString(), ": ",requirement.kind,  ": ", result)
        if (requirement.kind === 'must') {
            return result
        } else {
            return !result
        }
    }

    get password() {return this.pw;}

    /**
     * sets the password to the passed password, if it satisfies the specifications in the blueprint
     * @param newPassword the new password
     */
    set password(newPassword) {
        if (this._validatePassword(newPassword, this.blueprint)) {
            this.pw = newPassword;
        } else {
            throw "New password is not valid";
        }
    }

    /**
     * Get method for password minimum length
     * @returns {number} Password minimum length
     * @constructor
     */
    get passwordMinLength() {
        let minLength = 1;
        if(this.blueprint[0].minLength !== null){
            let minLength = this.blueprint[0].minLength;
        }

        return minLength;
    }


    /**
     * Get method for password maximum length
     * @returns {number} password maximum length
     */
    get passwordMaxLength(){
        let maxLength = 16;
        if(this.blueprint[0].maxLength !== null){
            maxLength = pwScheme.items.maxLength;
        }
        return maxLength;
    }

    /**
     * Returns the allowed character set
     * @returns {*} specified character set or a basic set if nothing was specified
     */
    getCharacterSet(){
        //basic character set that is assumed, if nothing is specified in the JSON scheme
        let baseCharSet = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890";
        let charSet = "";
        //add all specified Characters to the charSet-String that will be passed on to the Generator
        if(this.blueprint[0].allowedCharacterSets !== null){
            for(c in this.blueprint[0].allowedCharacterSets){
                charSet += c;
            }
        }
        //if no characters have been added to the set use the assumed basic set
        if(charSet !== ""){
            return charSet;
        }else{
            return baseCharSet;
        }

    }
}

module.exports = Player;
